<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Table Extractor with AI Context</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">
                    <i class="bi bi-file-earmark-pdf text-primary"></i>
                    PDF Table Extractor with AI Context
                </h1>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-upload"></i> Upload PDF Document</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="upload-area">
                            <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #007bff;"></i>
                            <h4>Drop PDF file here or click to browse</h4>
                            <p class="text-muted">Supports PDF files up to 50MB</p>
                            <input type="file" id="pdf-input" accept=".pdf" style="display: none;">
                            <button class="btn btn-primary" onclick="document.getElementById('pdf-input').click()">
                                <i class="bi bi-folder2-open"></i> Browse Files
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Section -->
        <div class="row mb-4" id="processing-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-gear"></i> AI Processing</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mt-3">
                            <button id="process-ai-btn" class="btn btn-primary btn-lg">
                                <i class="bi bi-gear"></i> Process with AI
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="showJsonModal()">
                                <i class="bi bi-code"></i> View Raw Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt Testing Section -->
        <div class="row mb-4" id="prompt-testing-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-chat-square-text"></i> Custom Prompt Testing</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="custom-prompt" class="form-label">Custom Context Extraction Prompt:</label>
                            <textarea class="form-control" id="custom-prompt" rows="6" 
                                 placeholder="Enter your custom prompt here. Use {row_data} and {text_content} as placeholders.">You are a meticulous document analysis system. Your task is to:

Entity Context Collection
For {row_data}, collect all full sentences from {text_content} that describe or mention the entity by name, value, or identifier.
Always extract the entire sentence/paragraph, never fragments.
Keep duplicates only if they are in separate parts of the document and contextually meaningful.

Concatenation
Merge all entity-related sentences into one coherent block, preserving original order of appearance in the document.
Separate sentences with a period or newline (do not cut off mid-sentence).

Language Integrity
Copy text exactly as it appears (same words, punctuation, grammar, and casing).
Do not paraphrase, summarize, or "clean up" wording.

General Commentary
Any text that does not belong to an entity (i.e., not tied to any field/value) must be placed, word-for-word, into the "General Commentary" row.
This row should contain all leftover text after entity contexts are assigned.

No Text Loss Guarantee
Every word from the input document must appear in the output (either in entity context or in general commentary).
If in doubt whether a sentence belongs to an entity â†’ place it in General Commentary instead of discarding.

Return JSON:
For entity rows:
{"context": "all related sentences for this entity, in order, exact wording", "general_commentary": null}

For the general commentary row:
{"context": null, "general_commentary": "all remaining sentences word-for-word, in order"}</textarea>
                        </div>
                        <div class="text-center">
                            <button id="test-prompt-btn" class="btn btn-success">
                                <i class="bi bi-play-circle"></i> Test Custom Prompt
                            </button>
                            <button id="clear-prompt-btn" class="btn btn-outline-secondary ms-2">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="loading-spinner text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" id="loading-text">Processing...</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row" id="results-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-table"></i> Extracted Data with AI Context</h5>
                        <div>
                            <button class="btn btn-primary" id="export-xlsx-btn"><i class="bi bi-file-earmark-excel"></i> Export as XLSX</button>
                            <button class="btn btn-outline-success" id="export-csv-btn">Export as CSV</button>
                            <button class="btn btn-outline-primary" id="export-json-btn">Export as JSON</button>
                            <button class="btn btn-outline-danger" id="export-pdf-btn">Export as PDF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="results-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 25%;">Field</th>
                                        <th style="width: 25%;">Value</th>
                                        <th style="width: 50%;">Context</th>
                                    </tr>
                                </thead>
                                <tbody id="results-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt Results Section -->
        <div class="row mt-4" id="prompt-results" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-check-circle"></i> Custom Prompt Test Results</h5>
                        <div>
                            <button class="btn btn-primary btn-sm" id="export-prompt-xlsx-btn">
                                <i class="bi bi-file-earmark-excel"></i> Export XLSX
                            </button>
                            <button class="btn btn-outline-success btn-sm" id="export-prompt-csv-btn">
                                <i class="bi bi-file-earmark-text"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-success">
                                    <tr>
                                        <th style="width: 25%;">Field</th>
                                        <th style="width: 25%;">Value</th>
                                        <th style="width: 50%;">Context (Custom Prompt)</th>
                                    </tr>
                                </thead>
                                <tbody id="context-results-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div class="row mt-3">
            <div class="col-12">
                <div id="status-messages"></div>
            </div>
        </div>
    </div>

    <!-- Raw Data Modal -->
    <div class="modal fade" id="jsonModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Raw Extracted Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="json-content" class="bg-light p-3" style="max-height: 500px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/script.js"></script>
</body>
</html>